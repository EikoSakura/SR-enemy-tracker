<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sovereign Regalia - Enemy Tracker</title>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --border: #1f4068;
      --accent: #e94560;
      --accent-hover: #ff6b6b;
      --text: #eaeaea;
      --text-dim: #a0a0a0;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #ef4444;
      --input-bg: #0a0a1a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      font-size: 13px;
      line-height: 1.4;
      min-height: 100vh;
      padding: 12px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--accent);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
    }

    .persistence-notice {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 10px;
    }

    .persistence-notice.obr {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .persistence-notice.local {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.obr { background: var(--success); }
    .status-dot.local { background: var(--warning); }

    .toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }

    .tab {
      flex: 1;
      padding: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      color: var(--text-dim);
      transition: all 0.2s;
    }

    .tab:hover {
      border-color: var(--accent);
    }

    .tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .enemy-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .enemy-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .enemy-card.selected {
      border-color: var(--accent);
    }

    .enemy-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: var(--bg-card);
    }

    .enemy-name {
      font-weight: 600;
      font-size: 14px;
    }

    .enemy-type {
      font-size: 11px;
      color: var(--text-dim);
    }

    .hp-bar-container {
      position: relative;
      height: 20px;
      background: var(--bg-primary);
      margin: 8px;
      border-radius: 3px;
      overflow: hidden;
    }

    .hp-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--danger), var(--warning));
      transition: width 0.3s;
    }

    .hp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    .stat-row {
      display: flex;
      justify-content: space-around;
      padding: 6px 8px;
      gap: 4px;
    }

    .stat-box {
      text-align: center;
      min-width: 40px;
    }

    .stat-label {
      font-size: 9px;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 600;
    }

    .stat-value.base-dmg {
      color: var(--accent);
    }

    .attacks-list {
      padding: 6px 8px;
      border-top: 1px solid var(--border);
    }

    .attack-item {
      display: flex;
      flex-direction: column;
      padding: 4px 6px;
      margin-bottom: 4px;
      background: var(--bg-card);
      border-radius: 3px;
      cursor: pointer;
    }

    .attack-item:last-child {
      margin-bottom: 0;
    }

    .attack-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .atk-name {
      font-weight: 500;
      font-size: 12px;
    }

    .atk-stats {
      font-size: 10px;
      color: var(--text-dim);
    }

    .attack-item-effect {
      display: none;
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px dashed var(--border);
    }

    .attack-item.expanded .attack-item-effect {
      display: block;
    }

    .atk-toggle {
      font-size: 8px;
      color: var(--text-dim);
      transition: transform 0.2s;
    }

    .attack-item.expanded .atk-toggle {
      transform: rotate(180deg);
    }

    .element-interactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 6px 8px;
    }

    .interaction-tag {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
    }

    .interaction-tag.weakness { background: #662222; color: #ff8888; }
    .interaction-tag.resistance { background: #224466; color: #88bbff; }
    .interaction-tag.immunity { background: #444444; color: #cccccc; }
    .interaction-tag.absorb { background: #226622; color: #88ff88; }

    .ability-section {
      border-top: 1px solid var(--border);
    }

    .ability-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      color: var(--accent);
    }

    .ability-header:hover {
      background: rgba(233, 69, 96, 0.1);
    }

    .ability-toggle {
      font-size: 10px;
      color: var(--text-dim);
      transition: transform 0.2s;
    }

    .ability-section.expanded .ability-toggle {
      transform: rotate(180deg);
    }

    .ability-content {
      display: none;
      padding: 8px;
      font-size: 11px;
      line-height: 1.5;
      background: var(--bg-card);
      white-space: pre-wrap;
    }

    .ability-section.expanded .ability-content {
      display: block;
    }

    .calc-section {
      margin: 8px;
      background: var(--bg-card);
      border-radius: 4px;
      overflow: hidden;
    }

    .calc-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
    }

    .calc-header:hover {
      background: rgba(233, 69, 96, 0.1);
    }

    .calc-toggle {
      color: var(--text-dim);
      font-size: 10px;
      transition: transform 0.2s;
    }

    .calc-section.expanded .calc-toggle {
      transform: rotate(180deg);
    }

    .calc-content {
      display: none;
      padding: 8px;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .calc-section.expanded .calc-content {
      display: block;
    }

    .calc-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .calc-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      min-width: 50px;
    }

    .tier-buttons {
      display: flex;
      gap: 4px;
    }

    .tier-btn {
      padding: 4px 8px;
      font-size: 10px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-dim);
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tier-btn:hover {
      border-color: var(--accent);
    }

    .tier-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .tier-btn.crit-btn.active {
      background: #cc8800;
      border-color: #cc8800;
    }

    .buff-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .buff-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .buff-item label {
      font-size: 9px;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .buff-item input {
      width: 100%;
      padding: 4px 6px;
      font-size: 11px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text);
      text-align: center;
    }

    .damage-result {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      background: var(--bg-card);
      border-radius: 4px;
      margin-top: 8px;
    }

    .damage-result-label {
      font-size: 11px;
      color: var(--text-dim);
    }

    .damage-result-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .damage-result-value.crit {
      color: #ffaa00;
    }

    .damage-breakdown {
      font-size: 9px;
      color: var(--text-dim);
      text-align: center;
      margin-top: 4px;
    }

    .apply-damage-btn {
      margin-left: 8px;
    }

    .quick-actions {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-top: 1px solid var(--border);
    }

    .damage-input {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .damage-input input {
      width: 40px;
      text-align: center;
      padding: 4px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text);
    }

    .editor-panel {
      display: none;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 6px;
    }

    .editor-panel.active {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 6px 8px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 12px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group textarea {
      min-height: 60px;
      resize: vertical;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      margin: 12px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }

    .attacks-editor {
      margin-bottom: 10px;
    }

    .attack-entry {
      background: var(--bg-card);
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .attack-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .no-enemies {
      text-align: center;
      color: var(--text-dim);
      padding: 40px 20px;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚öîÔ∏è Enemy Tracker</h1>
    <button class="btn btn-primary" id="addEnemy">+ Add Enemy</button>
  </div>

  <div class="persistence-notice local" id="persistenceNotice">
    <span class="status-dot local" id="statusDot"></span>
    <span id="persistenceText">Checking connection...</span>
  </div>

  <div class="toolbar">
    <button class="btn btn-secondary btn-small" id="exportBtn">üì§ Export</button>
    <button class="btn btn-secondary btn-small" id="importBtn">üì• Import</button>
    <button class="btn btn-danger btn-small" id="clearAllBtn">üóëÔ∏è Clear All</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="list">Enemy List</div>
    <div class="tab" data-tab="editor">Edit</div>
  </div>

  <div id="listView">
    <div class="enemy-list" id="enemyList">
      <div class="no-enemies">No enemies added yet.<br>Click "+ Add Enemy" to create one.</div>
    </div>
  </div>

  <div id="editorView" class="editor-panel">
    <div class="form-row">
      <div class="form-group" style="flex: 2">
        <label>Name</label>
        <input type="text" id="enemyName" placeholder="Enemy Name">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="enemyType">
          <option value="Humanoid">Humanoid</option>
          <option value="Beast">Beast</option>
          <option value="Construct">Construct</option>
          <option value="Monster">Monster</option>
          <option value="Spirit">Spirit</option>
          <option value="Undead">Undead</option>
        </select>
      </div>
    </div>

    <div class="section-title">Combat Stats</div>

    <div class="form-row">
      <div class="form-group">
        <label>Max HP</label>
        <input type="number" id="maxHp" value="10" min="1">
      </div>
      <div class="form-group">
        <label>Current HP</label>
        <input type="number" id="currentHp" value="10" min="0">
      </div>
      <div class="form-group">
        <label>Size</label>
        <input type="number" id="enemySize" value="1" min="1" max="4">
      </div>
      <div class="form-group">
        <label>Init</label>
        <input type="number" id="enemyInit" value="0" min="0">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>MOV</label>
        <input type="number" id="enemyMov" value="4" min="0">
      </div>
      <div class="form-group">
        <label>EVA</label>
        <input type="number" id="enemyEva" value="9" min="0">
      </div>
      <div class="form-group">
        <label>M.EVA</label>
        <input type="number" id="enemyMeva" value="8" min="0">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Guard</label>
        <input type="number" id="enemyGuard" value="1" min="0">
      </div>
      <div class="form-group">
        <label>Barrier</label>
        <input type="number" id="enemyBarrier" value="0" min="0">
      </div>
      <div class="form-group">
        <label>Base Damage</label>
        <input type="number" id="enemyBaseDamage" value="0" min="0" max="4">
      </div>
    </div>

    <div class="section-title">Attacks</div>
    <div class="attacks-editor" id="attacksEditor"></div>
    <button class="btn btn-secondary btn-small" id="addAttackBtn">+ Add Attack</button>

    <div class="section-title">Element Interactions</div>
    <div class="form-row">
      <div class="form-group">
        <label>Weaknesses</label>
        <input type="text" id="enemyWeaknesses" placeholder="Flame, Light">
      </div>
      <div class="form-group">
        <label>Resistances</label>
        <input type="text" id="enemyResistances" placeholder="Steel">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Immunities</label>
        <input type="text" id="enemyImmunities" placeholder="Venom">
      </div>
      <div class="form-group">
        <label>Absorbs</label>
        <input type="text" id="enemyAbsorbs" placeholder="Shadow">
      </div>
    </div>

    <div class="section-title">Abilities</div>
    <div class="form-group">
      <label>Abilities (Format: ABILITY NAME: Description)</label>
      <textarea id="enemyAbilityDesc" placeholder="PACK TACTICS: +2 to attack when ally within 1 space.&#10;&#10;FLEE: When leader defeated, flees battlefield."></textarea>
    </div>

    <div style="display: flex; gap: 8px; margin-top: 16px;">
      <button class="btn btn-primary" id="saveEnemyBtn" style="flex:1">Save Enemy</button>
      <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
      <button class="btn btn-danger" id="deleteEnemyBtn">Delete</button>
    </div>
  </div>

  <script type="module">
    // Import OBR SDK
    import OBR from 'https://unpkg.com/@owlbear-rodeo/sdk@latest/dist/index.js';

    // State
    let enemies = [];
    let selectedEnemyId = null;
    let editAttacks = [];
    let obrReady = false;

    // Elements
    const enemyList = document.getElementById('enemyList');
    const listView = document.getElementById('listView');
    const editorView = document.getElementById('editorView');
    const persistenceNotice = document.getElementById('persistenceNotice');
    const statusDot = document.getElementById('statusDot');
    const persistenceText = document.getElementById('persistenceText');
    const attacksEditor = document.getElementById('attacksEditor');

    // Initialize OBR
    OBR.onReady(async () => {
      obrReady = true;
      persistenceNotice.classList.remove('local');
      persistenceNotice.classList.add('obr');
      statusDot.classList.remove('local');
      statusDot.classList.add('obr');
      persistenceText.textContent = 'Connected to Owlbear Rodeo - data synced';
      
      await loadEnemies();
      renderEnemyList();
    });

    // Fallback to localStorage if OBR not ready after 2 seconds
    setTimeout(() => {
      if (!obrReady) {
        persistenceText.textContent = 'Standalone mode - data saved locally';
        loadFromLocalStorage();
        renderEnemyList();
      }
    }, 2000);

    // Storage functions
    async function loadEnemies() {
      if (obrReady) {
        try {
          const metadata = await OBR.room.getMetadata();
          enemies = metadata['sr-enemies'] || [];
        } catch (e) {
          console.error('Failed to load from OBR:', e);
          loadFromLocalStorage();
        }
      } else {
        loadFromLocalStorage();
      }
    }

    async function saveEnemies() {
      if (obrReady) {
        try {
          await OBR.room.setMetadata({ 'sr-enemies': enemies });
        } catch (e) {
          console.error('Failed to save to OBR:', e);
        }
      }
      saveToLocalStorage();
    }

    function loadFromLocalStorage() {
      try {
        const stored = localStorage.getItem('sr-enemies');
        if (stored) {
          enemies = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
      }
    }

    function saveToLocalStorage() {
      try {
        localStorage.setItem('sr-enemies', JSON.stringify(enemies));
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    // Render enemy list
    function renderEnemyList() {
      if (enemies.length === 0) {
        enemyList.innerHTML = '<div class="no-enemies">No enemies added yet.<br>Click "+ Add Enemy" to create one.</div>';
        return;
      }

      enemyList.innerHTML = enemies.map(enemy => {
        const hpPercent = Math.max(0, Math.min(100, (enemy.currentHp / enemy.maxHp) * 100));
        
        // Build attacks HTML
        let attacksHtml = '';
        if (enemy.attacks && enemy.attacks.length > 0) {
          attacksHtml = '<div class="attacks-list">';
          enemy.attacks.forEach((atk, idx) => {
            const hasEffect = atk.effect && atk.effect.trim();
            attacksHtml += '<div class="attack-item" data-enemy-id="' + enemy.id + '" data-attack-idx="' + idx + '">' +
              '<div class="attack-item-header">' +
              '<span class="atk-name">' + (atk.name || 'Attack') + '</span>' +
              '<span class="atk-stats">+' + atk.bonus + ' ' + atk.aspect + ' ¬∑ ' + atk.element + (hasEffect ? ' <span class="atk-toggle">‚ñº</span>' : '') + '</span>' +
              '</div>' +
              (hasEffect ? '<div class="attack-item-effect">' + atk.effect + '</div>' : '') +
              '</div>';
          });
          attacksHtml += '</div>';
        }

        // Build element interactions
        let interactionsHtml = '';
        if (enemy.weaknesses) interactionsHtml += '<span class="interaction-tag weakness">‚ö†Ô∏è ' + enemy.weaknesses + '</span>';
        if (enemy.resistances) interactionsHtml += '<span class="interaction-tag resistance">üõ°Ô∏è ' + enemy.resistances + '</span>';
        if (enemy.immunities) interactionsHtml += '<span class="interaction-tag immunity">üö´ ' + enemy.immunities + '</span>';
        if (enemy.absorbs) interactionsHtml += '<span class="interaction-tag absorb">üíö ' + enemy.absorbs + '</span>';

        // Build abilities HTML
        let abilityHtml = '';
        if (enemy.abilityDesc) {
          abilityHtml = '<div class="ability-section" data-enemy-id="' + enemy.id + '">' +
            '<div class="ability-header">' +
            '<span class="ability-name">üìú Abilities</span>' +
            '<span class="ability-toggle">‚ñº</span>' +
            '</div>' +
            '<div class="ability-content">' + enemy.abilityDesc + '</div>' +
            '</div>';
        }

        // Build damage calculator HTML
        const calcHtml = '<div class="calc-section" data-enemy-id="' + enemy.id + '">' +
          '<div class="calc-header">' +
          '<span>üéØ Damage Calculator</span>' +
          '<span class="calc-toggle">‚ñº</span>' +
          '</div>' +
          '<div class="calc-content">' +
          '<div class="calc-row">' +
          '<span class="calc-label">Hit Tier</span>' +
          '<div class="tier-buttons">' +
          '<button class="tier-btn" data-tier="noble" data-enemy-id="' + enemy.id + '">Noble (2)</button>' +
          '<button class="tier-btn" data-tier="royal" data-enemy-id="' + enemy.id + '">Royal (3)</button>' +
          '<button class="tier-btn" data-tier="imperial" data-enemy-id="' + enemy.id + '">Imperial (4)</button>' +
          '</div>' +
          '</div>' +
          '<div class="calc-row">' +
          '<span class="calc-label">Critical</span>' +
          '<div class="tier-buttons">' +
          '<button class="tier-btn crit-btn" data-crit="true" data-enemy-id="' + enemy.id + '">‚ö° Critical (√ó3)</button>' +
          '</div>' +
          '</div>' +
          '<div class="buff-grid">' +
          '<div class="buff-item">' +
          '<label>Base Dmg</label>' +
          '<input type="number" class="buff-base" data-enemy-id="' + enemy.id + '" value="' + (enemy.baseDamage || 0) + '" min="0" max="10">' +
          '</div>' +
          '<div class="buff-item">' +
          '<label>+Damage</label>' +
          '<input type="number" class="buff-dmg" data-enemy-id="' + enemy.id + '" value="0" min="-10" max="20">' +
          '</div>' +
          '<div class="buff-item">' +
          '<label>‚àíReduction</label>' +
          '<input type="number" class="buff-pen" data-enemy-id="' + enemy.id + '" value="0" min="0" max="10">' +
          '</div>' +
          '</div>' +
          '<div class="damage-result">' +
          '<div>' +
          '<span class="damage-result-label">Total Damage: </span>' +
          '<span class="damage-result-value" data-enemy-id="' + enemy.id + '">‚Äî</span>' +
          '</div>' +
          '<button class="btn btn-danger btn-small apply-damage-btn" data-enemy-id="' + enemy.id + '">Apply</button>' +
          '</div>' +
          '<div class="damage-breakdown" data-enemy-id="' + enemy.id + '">Select a hit tier</div>' +
          '</div>' +
          '</div>';

        return '<div class="enemy-card' + (selectedEnemyId === enemy.id ? ' selected' : '') + '" data-id="' + enemy.id + '">' +
          '<div class="enemy-card-header">' +
          '<span class="enemy-name">' + (enemy.name || 'Unnamed') + '</span>' +
          '<div style="display: flex; align-items: center; gap: 6px;">' +
          '<span class="enemy-type">' + enemy.type + (enemy.size > 1 ? ' (Size ' + enemy.size + ')' : '') + (enemy.init > 0 ? ' [Init ' + enemy.init + ']' : '') + '</span>' +
          '<button class="btn btn-small btn-danger delete-card-btn" data-id="' + enemy.id + '" title="Delete">‚úï</button>' +
          '</div>' +
          '</div>' +
          '<div class="hp-bar-container">' +
          '<div class="hp-bar" style="width: ' + hpPercent + '%"></div>' +
          '<span class="hp-text">' + enemy.currentHp + ' / ' + enemy.maxHp + '</span>' +
          '</div>' +
          '<div class="stat-row">' +
          '<div class="stat-box"><div class="stat-label">MOV</div><div class="stat-value">' + enemy.mov + '</div></div>' +
          '<div class="stat-box"><div class="stat-label">EVA</div><div class="stat-value">' + enemy.eva + '</div></div>' +
          '<div class="stat-box"><div class="stat-label">M.EVA</div><div class="stat-value">' + enemy.meva + '</div></div>' +
          '<div class="stat-box"><div class="stat-label">GRD</div><div class="stat-value">' + enemy.guard + '</div></div>' +
          '<div class="stat-box"><div class="stat-label">BAR</div><div class="stat-value">' + enemy.barrier + '</div></div>' +
          '<div class="stat-box"><div class="stat-label">BASE</div><div class="stat-value base-dmg">+' + (enemy.baseDamage || 0) + '</div></div>' +
          '</div>' +
          attacksHtml +
          (interactionsHtml ? '<div class="element-interactions">' + interactionsHtml + '</div>' : '') +
          abilityHtml +
          calcHtml +
          '<div class="quick-actions">' +
          '<div class="damage-input">' +
          '<button class="btn btn-small btn-secondary heal-btn" data-id="' + enemy.id + '">+</button>' +
          '<input type="number" class="hp-change" data-id="' + enemy.id + '" value="1" min="1">' +
          '<button class="btn btn-small btn-danger damage-btn" data-id="' + enemy.id + '">‚àí</button>' +
          '</div>' +
          '<button class="btn btn-small btn-secondary edit-btn" data-id="' + enemy.id + '" style="margin-left: auto">Edit</button>' +
          '</div>' +
          '</div>';
      }).join('');

      attachCardListeners();
    }

    // Attach event listeners to cards
    function attachCardListeners() {
      // Delete buttons
      document.querySelectorAll('.delete-card-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (confirm('Delete this enemy?')) {
            enemies = enemies.filter(en => en.id !== id);
            await saveEnemies();
            renderEnemyList();
          }
        });
      });

      // Edit buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          editEnemy(id);
        });
      });

      // Heal buttons
      document.querySelectorAll('.heal-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const input = document.querySelector('.hp-change[data-id="' + id + '"]');
          const amount = parseInt(input.value) || 1;
          await changeHp(id, amount);
        });
      });

      // Damage buttons
      document.querySelectorAll('.damage-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const input = document.querySelector('.hp-change[data-id="' + id + '"]');
          const amount = parseInt(input.value) || 1;
          await changeHp(id, -amount);
        });
      });

      // Attack item toggles
      document.querySelectorAll('.attack-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (item.querySelector('.attack-item-effect')) {
            item.classList.toggle('expanded');
          }
        });
      });

      // Ability section toggles
      document.querySelectorAll('.ability-header').forEach(header => {
        header.addEventListener('click', (e) => {
          e.stopPropagation();
          header.parentElement.classList.toggle('expanded');
        });
      });

      // Calc section toggles
      document.querySelectorAll('.calc-header').forEach(header => {
        header.addEventListener('click', (e) => {
          e.stopPropagation();
          header.parentElement.classList.toggle('expanded');
        });
      });

      // Tier buttons
      document.querySelectorAll('.tier-btn[data-tier]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const enemyId = btn.dataset.enemyId;
          const tier = btn.dataset.tier;
          
          // Toggle active state within same enemy's tier buttons
          document.querySelectorAll('.tier-btn[data-tier][data-enemy-id="' + enemyId + '"]').forEach(b => {
            if (b === btn) {
              b.classList.toggle('active');
            } else {
              b.classList.remove('active');
            }
          });
          
          calculateDamage(enemyId);
        });
      });

      // Crit buttons
      document.querySelectorAll('.tier-btn[data-crit]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          btn.classList.toggle('active');
          calculateDamage(btn.dataset.enemyId);
        });
      });

      // Buff inputs
      document.querySelectorAll('.buff-dmg, .buff-base, .buff-pen').forEach(input => {
        input.addEventListener('input', (e) => {
          calculateDamage(input.dataset.enemyId);
        });
        input.addEventListener('click', (e) => e.stopPropagation());
      });

      // Apply damage buttons
      document.querySelectorAll('.apply-damage-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const enemyId = btn.dataset.enemyId;
          const resultEl = document.querySelector('.damage-result-value[data-enemy-id="' + enemyId + '"]');
          const damage = parseInt(resultEl.textContent);
          
          if (!isNaN(damage) && damage > 0) {
            await changeHp(enemyId, -damage);
          }
        });
      });
    }

    // Calculate damage
    function calculateDamage(enemyId) {
      const tierBtns = document.querySelectorAll('.tier-btn[data-tier][data-enemy-id="' + enemyId + '"]');
      const critBtn = document.querySelector('.tier-btn[data-crit][data-enemy-id="' + enemyId + '"]');
      const baseDmgInput = document.querySelector('.buff-base[data-enemy-id="' + enemyId + '"]');
      const bonusDmgInput = document.querySelector('.buff-dmg[data-enemy-id="' + enemyId + '"]');
      const penInput = document.querySelector('.buff-pen[data-enemy-id="' + enemyId + '"]');
      const resultEl = document.querySelector('.damage-result-value[data-enemy-id="' + enemyId + '"]');
      const breakdownEl = document.querySelector('.damage-breakdown[data-enemy-id="' + enemyId + '"]');

      let tierDamage = 0;
      let tierName = '';
      tierBtns.forEach(btn => {
        if (btn.classList.contains('active')) {
          const tier = btn.dataset.tier;
          if (tier === 'noble') { tierDamage = 2; tierName = 'Noble'; }
          if (tier === 'royal') { tierDamage = 3; tierName = 'Royal'; }
          if (tier === 'imperial') { tierDamage = 4; tierName = 'Imperial'; }
        }
      });

      if (tierDamage === 0) {
        resultEl.textContent = '‚Äî';
        resultEl.classList.remove('crit');
        breakdownEl.textContent = 'Select a hit tier';
        return;
      }

      const baseDmg = parseInt(baseDmgInput.value) || 0;
      const bonusDmg = parseInt(bonusDmgInput.value) || 0;
      const pen = parseInt(penInput.value) || 0;
      const isCrit = critBtn && critBtn.classList.contains('active');

      let total = tierDamage + baseDmg + bonusDmg;
      let breakdown = tierName + ' (' + tierDamage + ') + Base (' + baseDmg + ')';
      
      if (bonusDmg !== 0) {
        breakdown += ' + Buff (' + (bonusDmg > 0 ? '+' : '') + bonusDmg + ')';
      }

      if (isCrit) {
        total = total * 3;
        breakdown += ' √ó 3 crit';
      }

      if (pen > 0) {
        breakdown += ' (ignores ' + pen + ' reduction)';
      }

      breakdown += ' = ' + total;

      resultEl.textContent = total;
      resultEl.classList.toggle('crit', isCrit);
      breakdownEl.textContent = breakdown;
    }

    // Change HP
    async function changeHp(enemyId, amount) {
      const enemy = enemies.find(e => e.id === enemyId);
      if (!enemy) return;

      enemy.currentHp = Math.max(0, Math.min(enemy.maxHp, enemy.currentHp + amount));
      
      if (enemy.currentHp === 0 && obrReady) {
        OBR.notification.show(enemy.name + ' has been defeated!', 'WARNING');
      }

      await saveEnemies();
      renderEnemyList();
    }

    // Edit enemy
    function editEnemy(id) {
      const enemy = enemies.find(e => e.id === id);
      if (!enemy) return;

      selectedEnemyId = id;

      document.getElementById('enemyName').value = enemy.name || '';
      document.getElementById('enemyType').value = enemy.type || 'Humanoid';
      document.getElementById('maxHp').value = enemy.maxHp || 10;
      document.getElementById('currentHp').value = enemy.currentHp || 10;
      document.getElementById('enemySize').value = enemy.size || 1;
      document.getElementById('enemyInit').value = enemy.init || 0;
      document.getElementById('enemyMov').value = enemy.mov || 4;
      document.getElementById('enemyEva').value = enemy.eva || 9;
      document.getElementById('enemyMeva').value = enemy.meva || 8;
      document.getElementById('enemyGuard').value = enemy.guard || 1;
      document.getElementById('enemyBarrier').value = enemy.barrier || 0;
      document.getElementById('enemyBaseDamage').value = enemy.baseDamage || 0;
      document.getElementById('enemyWeaknesses').value = enemy.weaknesses || '';
      document.getElementById('enemyResistances').value = enemy.resistances || '';
      document.getElementById('enemyImmunities').value = enemy.immunities || '';
      document.getElementById('enemyAbsorbs').value = enemy.absorbs || '';
      document.getElementById('enemyAbilityDesc').value = enemy.abilityDesc || '';

      editAttacks = enemy.attacks ? JSON.parse(JSON.stringify(enemy.attacks)) : [];
      renderAttacksEditor();

      showTab('editor');
    }

    // Render attacks editor
    function renderAttacksEditor() {
      if (editAttacks.length === 0) {
        attacksEditor.innerHTML = '<div style="color: var(--text-dim); font-size: 11px;">No attacks added yet.</div>';
        return;
      }

      attacksEditor.innerHTML = editAttacks.map((atk, idx) => {
        return '<div class="attack-entry" data-idx="' + idx + '">' +
          '<div class="attack-entry-header">' +
          '<span style="font-weight: 500;">Attack ' + (idx + 1) + '</span>' +
          '<button class="btn btn-danger btn-small remove-attack-btn" data-idx="' + idx + '">Remove</button>' +
          '</div>' +
          '<div class="form-row">' +
          '<div class="form-group" style="flex: 2">' +
          '<label>Name</label>' +
          '<input type="text" class="atk-name-input" data-idx="' + idx + '" value="' + (atk.name || '') + '" placeholder="Attack Name">' +
          '</div>' +
          '<div class="form-group">' +
          '<label>Bonus</label>' +
          '<input type="number" class="atk-bonus-input" data-idx="' + idx + '" value="' + (atk.bonus || 6) + '" min="0">' +
          '</div>' +
          '</div>' +
          '<div class="form-row">' +
          '<div class="form-group">' +
          '<label>Aspect</label>' +
          '<select class="atk-aspect-input" data-idx="' + idx + '">' +
          '<option value="Physical"' + (atk.aspect === 'Physical' ? ' selected' : '') + '>Physical</option>' +
          '<option value="Magical"' + (atk.aspect === 'Magical' ? ' selected' : '') + '>Magical</option>' +
          '</select>' +
          '</div>' +
          '<div class="form-group">' +
          '<label>Element</label>' +
          '<select class="atk-element-input" data-idx="' + idx + '">' +
          ['Steel', 'Flame', 'Frost', 'Storm', 'Gale', 'Stone', 'Tide', 'Venom', 'Light', 'Shadow', 'Spirit', 'Decay'].map(el => 
            '<option value="' + el + '"' + (atk.element === el ? ' selected' : '') + '>' + el + '</option>'
          ).join('') +
          '</select>' +
          '</div>' +
          '</div>' +
          '<div class="form-group">' +
          '<label>Effect</label>' +
          '<input type="text" class="atk-effect-input" data-idx="' + idx + '" value="' + (atk.effect || '') + '" placeholder="Ranged 2-5. On hit, push 1 space.">' +
          '</div>' +
          '</div>';
      }).join('');

      // Attach listeners
      document.querySelectorAll('.remove-attack-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          editAttacks.splice(idx, 1);
          renderAttacksEditor();
        });
      });

      document.querySelectorAll('.atk-name-input, .atk-bonus-input, .atk-aspect-input, .atk-element-input, .atk-effect-input').forEach(input => {
        input.addEventListener('change', () => {
          const idx = parseInt(input.dataset.idx);
          if (input.classList.contains('atk-name-input')) editAttacks[idx].name = input.value;
          if (input.classList.contains('atk-bonus-input')) editAttacks[idx].bonus = parseInt(input.value) || 6;
          if (input.classList.contains('atk-aspect-input')) editAttacks[idx].aspect = input.value;
          if (input.classList.contains('atk-element-input')) editAttacks[idx].element = input.value;
          if (input.classList.contains('atk-effect-input')) editAttacks[idx].effect = input.value;
        });
      });
    }

    // Show tab
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('active');
      
      listView.style.display = tabName === 'list' ? 'block' : 'none';
      editorView.classList.toggle('active', tabName === 'editor');
    }

    // Tab clicks
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        showTab(tab.dataset.tab);
      });
    });

    // Add enemy button
    document.getElementById('addEnemy').addEventListener('click', () => {
      selectedEnemyId = null;
      document.getElementById('enemyName').value = '';
      document.getElementById('enemyType').value = 'Humanoid';
      document.getElementById('maxHp').value = 10;
      document.getElementById('currentHp').value = 10;
      document.getElementById('enemySize').value = 1;
      document.getElementById('enemyInit').value = 0;
      document.getElementById('enemyMov').value = 4;
      document.getElementById('enemyEva').value = 9;
      document.getElementById('enemyMeva').value = 8;
      document.getElementById('enemyGuard').value = 1;
      document.getElementById('enemyBarrier').value = 0;
      document.getElementById('enemyBaseDamage').value = 0;
      document.getElementById('enemyWeaknesses').value = '';
      document.getElementById('enemyResistances').value = '';
      document.getElementById('enemyImmunities').value = '';
      document.getElementById('enemyAbsorbs').value = '';
      document.getElementById('enemyAbilityDesc').value = '';
      editAttacks = [{ name: 'Attack', bonus: 6, aspect: 'Physical', element: 'Steel', effect: '' }];
      renderAttacksEditor();
      showTab('editor');
    });

    // Add attack button
    document.getElementById('addAttackBtn').addEventListener('click', () => {
      editAttacks.push({ name: 'Attack', bonus: 6, aspect: 'Physical', element: 'Steel', effect: '' });
      renderAttacksEditor();
    });

    // Save enemy button
    document.getElementById('saveEnemyBtn').addEventListener('click', async () => {
      const enemyData = {
        id: selectedEnemyId || 'enemy-' + Date.now(),
        name: document.getElementById('enemyName').value || 'Unnamed Enemy',
        type: document.getElementById('enemyType').value,
        maxHp: parseInt(document.getElementById('maxHp').value) || 10,
        currentHp: parseInt(document.getElementById('currentHp').value) || 10,
        size: parseInt(document.getElementById('enemySize').value) || 1,
        init: parseInt(document.getElementById('enemyInit').value) || 0,
        mov: parseInt(document.getElementById('enemyMov').value) || 4,
        eva: parseInt(document.getElementById('enemyEva').value) || 9,
        meva: parseInt(document.getElementById('enemyMeva').value) || 8,
        guard: parseInt(document.getElementById('enemyGuard').value) || 0,
        barrier: parseInt(document.getElementById('enemyBarrier').value) || 0,
        baseDamage: parseInt(document.getElementById('enemyBaseDamage').value) || 0,
        attacks: editAttacks,
        weaknesses: document.getElementById('enemyWeaknesses').value,
        resistances: document.getElementById('enemyResistances').value,
        immunities: document.getElementById('enemyImmunities').value,
        absorbs: document.getElementById('enemyAbsorbs').value,
        abilityDesc: document.getElementById('enemyAbilityDesc').value
      };

      if (selectedEnemyId) {
        const idx = enemies.findIndex(e => e.id === selectedEnemyId);
        if (idx !== -1) {
          enemies[idx] = enemyData;
        }
      } else {
        enemies.push(enemyData);
      }

      await saveEnemies();
      renderEnemyList();
      showTab('list');

      if (obrReady) {
        OBR.notification.show('Enemy saved!', 'SUCCESS');
      }
    });

    // Cancel edit button
    document.getElementById('cancelEditBtn').addEventListener('click', () => {
      selectedEnemyId = null;
      showTab('list');
    });

    // Delete enemy button
    document.getElementById('deleteEnemyBtn').addEventListener('click', async () => {
      if (!selectedEnemyId) return;
      
      if (confirm('Delete this enemy?')) {
        enemies = enemies.filter(e => e.id !== selectedEnemyId);
        await saveEnemies();
        renderEnemyList();
        showTab('list');
        
        if (obrReady) {
          OBR.notification.show('Enemy deleted', 'WARNING');
        }
      }
    });

    // Export button
    document.getElementById('exportBtn').addEventListener('click', () => {
      const exportData = {
        version: '2.0',
        exportDate: new Date().toISOString(),
        encounter: 'Exported Enemies',
        enemies: enemies
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sr-enemies-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);

      if (obrReady) {
        OBR.notification.show('Enemies exported!', 'SUCCESS');
      }
    });

    // Import button
    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        let importedEnemies = [];
        if (Array.isArray(data)) {
          importedEnemies = data;
        } else if (data.enemies && Array.isArray(data.enemies)) {
          importedEnemies = data.enemies;
        }

        // Validate and add IDs if missing
        importedEnemies = importedEnemies.map(enemy => ({
          ...enemy,
          id: enemy.id || 'enemy-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
          baseDamage: enemy.baseDamage || 0
        }));

        const replaceAll = confirm('Replace all existing enemies?\n\nOK = Replace all\nCancel = Add to existing');
        
        if (replaceAll) {
          enemies = importedEnemies;
        } else {
          enemies = [...enemies, ...importedEnemies];
        }

        await saveEnemies();
        renderEnemyList();

        if (obrReady) {
          OBR.notification.show('Imported ' + importedEnemies.length + ' enemies!', 'SUCCESS');
        } else {
          alert('Imported ' + importedEnemies.length + ' enemies!');
        }
      } catch (err) {
        console.error('Import failed:', err);
        alert('Failed to import: ' + err.message);
      }

      e.target.value = '';
    });

    // Clear all button
    document.getElementById('clearAllBtn').addEventListener('click', async () => {
      if (enemies.length === 0) {
        alert('No enemies to clear!');
        return;
      }

      if (confirm('Are you sure you want to delete all ' + enemies.length + ' enemies?\n\nThis cannot be undone!')) {
        enemies = [];
        await saveEnemies();
        renderEnemyList();

        if (obrReady) {
          OBR.notification.show('All enemies cleared', 'WARNING');
        }
      }
    });
  </script>
</body>
</html>
